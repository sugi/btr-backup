#!/bin/bash
set -e

backup_base=/backup
target="${1%/}"
shift

if (echo "${target}" | egrep -q "^[0-9a-zA-Z.-]+:"); then
  host=${target%:*}
  dest="${target#*:}"
else
  host=$(hostname)
  dest="${target}"
fi
dest="${dest////_}"
dest="${backup_base}/${host}/${dest#_}"

if [ -z "${target}" ]; then
  echo "Usage: $0 <target_dir> [rsync-options]" >&2
  exit 255
fi

if [ ! -d "${dest}" ]; then
  mkdir -p "${dest}"
fi

if [ ! -d "${dest}/cur" ]; then
  btrfs subvolume create "${dest}/cur"
fi

logopt=""
if [ -d /var/log/btr-backup ]; then
  logopt="--log-file=/var/log/btr-backup/rsync${target////_}.log"
fi

rsync -acSHXA --numeric-ids --del $logopt \
	"$@" "${target}/" "${dest}/cur/"
btrfs filesystem sync "${dest}/cur" > /dev/null
btrfs subvolume snapshot "${dest}/cur" "${dest}/$(date +%Y-%m-%dT%H:%M:%S)" > /dev/null
